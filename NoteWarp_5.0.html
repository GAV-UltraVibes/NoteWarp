<!DOCTYPE html>
<!--
NoteWarp ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–Ω—ã—Ö –Ω–µ–±–æ–ª—å—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å –∞–≤—Ç–æ–∑–∞–º–µ–Ω–æ–π —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
‚Ä¢ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
‚Ä¢ –ï–¥–∏–Ω—ã–π —Ñ–∞–π–ª (self-contained HTML+JS)
‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —Å–ª–æ–≤–∞—Ä–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚Ä¢ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
‚Ä¢ –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —à–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏–∏
‚Ä¢ –ö–∞—Å–∫–∞–¥–Ω—ã–µ –∑–∞–º–µ–Ω—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—ë¬ª (–æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ = –æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
‚Ä¢ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–ª–æ–≤–∞—Ä–µ–π)

–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏:
‚Ä¢ [–¥–∞—Ç–∞] ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (14.02.2026)
‚Ä¢ [–¥–∞—Ç–∞_iso] ‚Üí ISO —Ñ–æ—Ä–º–∞—Ç (2026-02-14)
‚Ä¢ [–≤—Ä–µ–º—è] ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç (14:30)
‚Ä¢ [–≤—Ä–µ–º—è_iso] ‚Üí –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (14:30:22)
‚Ä¢ [–¥–∞—Ç–∞_–≤—Ä–µ–º—è] ‚Üí –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (2026-02-14 14:30)
‚Ä¢ [–¥–∞—Ç–∞_–≤—Ä–µ–º—è_–ª–æ–∫] ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

Copyright (c) 2024-2026 –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–∞—Ä–∫–∞–≤—Ü–µ–≤, Qwen, DeepSeek, –ê–ª–∏—Å–∞

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<html>
<head>
<title>NoteWarp - —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –∞–≤—Ç–æ–∑–∞–º–µ–Ω–∞–º–∏</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  max-width: 80%;
  margin: 0 auto;
}
.app-header {
  text-align: center;
  margin-bottom: 20px;
}
.app-title {
  font-family: 'Arial Rounded MT Bold', 'Helvetica Neue', sans-serif;
  font-weight: normal;
  font-size: 2.8em;
  background: linear-gradient(45deg, #007cba, #00cc66);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 10px 0;
  letter-spacing: -0.5px;
  text-align: center;
}
.tabs {
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
}
.tab-buttons-container {
  display: flex;
}
.tab-button {
  padding: 10px 20px;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  cursor: pointer;
  margin-right: 5px;
}
.tab-button.active {
  background-color: #007cba;
  color: white;
}
.header-controls {
  display: flex;
  gap: 5px;
}
.settings-button, .help-button {
  padding: 8px 12px;
  background-color: #6c757d;
  color: white;
  border: 1px solid #5a6268;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}
.settings-button:hover, .help-button:hover {
  background-color: #5a6268;
}
#editor-tab, #dictionary-tab {
  display: none;
}
#editor-tab.active, #dictionary-tab.active {
  display: block;
}
#editor {
  width: 100%;
  height: 60vh;
  border: 1px solid #ccc;
  padding: 10px;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.4;
  outline: none;
  background-color: white;
  box-sizing: border-box;
  resize: vertical;
}
#editor:focus {
  border-color: #007cba;
}
.tools-panel {
  margin-top: 10px;
  padding: 8px;
  background-color: #e9ecef;
  border-radius: 5px;
  border: 1px solid #ced4da;
}
.tool-btn {
  padding: 8px 15px;
  background-color: #17a2b8;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  font-size: 14px;
}
.tool-btn:hover {
  background-color: #138496;
}
.save-panel {
  margin-top: 10px;
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 5px;
  border: 1px solid #e9ecef;
}
.save-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}
.filename-input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
}
.save-button {
  padding: 8px 15px;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}
.save-button:hover {
  background-color: #218838;
}
.save-button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}
.filename-error {
  color: #dc3545;
  font-size: 12px;
  margin-top: 5px;
  display: none;
}
.dictionary-manager {
  display: block;
}
.shortcuts-list {
  width: 48%;
  float: left;
  border: transparent;
  padding: 10px;
  box-sizing: border-box;
}
.replacement-editor {
  width: 48%;
  float: right;
  padding: 10px;
  box-sizing: border-box;
}
.dictionary-panel {
  margin-bottom: 15px;
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 5px;
  border: 1px solid #e9ecef;
}
.dictionary-panel h3 {
  margin-top: 0;
  color: #007cba;
}
.editing-dict-panel {
  margin-bottom: 15px;
  padding: 10px;
  background-color: #e9ecef;
  border-radius: 5px;
  border: 1px solid #ced4da;
}
.editing-dict-panel h3 {
  margin-top: 0;
  color: #495057;
}
.editing-substitution-panel {
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 5px;
  border: 1px solid #e9ecef;
}
.editing-substitution-panel h3 {
  margin-top: 0;
  color: #007cba;
}
.drop-zone {
  border: 2px dashed #ccc;
  border-radius: 5px;
  padding: 15px;
  text-align: center;
  margin-bottom: 10px;
  background-color: #f9f9f9;
  transition: all 0.3s;
}
.drop-zone.dragover {
  border-color: #007cba;
  background-color: #e3f2fd;
}
.dictionary-buttons {
  display: block;
}
.dictionary-buttons button {
  padding: 8px 15px;
  background-color: #17a2b8;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 3px;
  margin-right: 5px;
  margin-bottom: 5px;
}
.dictionary-buttons button:hover {
  background-color: #138496;
}
.shortcut-table-container {
  max-height: 35vh;
  overflow-y: auto;
  margin-bottom: 5px;
}
.current-dict-name {
  font-weight: bold;
  margin-bottom: 5px;
  padding: 2px 5px;
  background-color: #f0f0f0;
  border-radius: 3px;
}
.shortcut-table {
  width: 100%;
  border-collapse: collapse;
}
.shortcut-table th, .shortcut-table td {
  border: 1px solid #ddd;
  padding: 4px;
  text-align: left;
}
.shortcut-table th {
  background-color: #f2f2f2;
}
.shortcut-table tr:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}
.shortcut-table tr.selected {
  background-color: #007cba;
  color: white;
}
.shortcut-table tr.conflicting-shortcut-row {
  color: #dc3545;
  font-weight: bold;
  background-color: #ffeef0;
}
.shortcut-edit-field {
  margin-bottom: 10px;
}
.shortcut-edit-field label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}
.shortcut-edit-field input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  box-sizing: border-box;
}
.replacement-edit-field {
  display: block;
  margin-bottom: 10px;
}
.replacement-edit-field label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}
.replacement-edit-field textarea {
  width: 100%;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  padding: 10px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  border-radius: 3px;
  height: 60vh;
  resize: none;
}
.editor-buttons {
  display: block;
  text-align: right;
}
.editor-buttons button {
  padding: 8px 15px;
  border: none;
  cursor: pointer;
  border-radius: 3px;
  margin-left: 5px;
}
.editor-buttons button.save {
  background-color: #28a745;
  color: white;
}
.editor-buttons button.save:hover {
  background-color: #218838;
}
.editor-buttons button.delete {
  background-color: #dc3545;
  color: white;
}
.editor-buttons button.delete:hover {
  background-color: #c82333;
}
.editor-buttons button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}
.error-message {
  color: #dc3545;
  font-size: 12px;
  margin-top: 5px;
  display: none;
}
.dictionaries-list-container {
  margin-top: 15px;
}
.dictionaries-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
}
.dictionaries-table th, .dictionaries-table td {
  border: 1px solid #ddd;
  padding: 5px;
  text-align: left;
}
.dictionaries-table th {
  background-color: #f2f2f2;
}
.dictionaries-table .toggle-cell {
  width: 1%;
  white-space: nowrap;
}
.dictionaries-table .name-cell {
  width: auto;
}
.dictionaries-table .actions-cell {
  width: 1%;
  white-space: nowrap;
}
.conflict-status {
  margin-top: 10px;
  padding: 5px;
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  color: #856404;
  border-radius: 3px;
  font-size: 12px;
  display: none;
}
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.popup-content {
  background: white;
  padding: 20px;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}
.popup-content input {
  width: 100%;
  padding: 8px;
  margin-top: 10px;
  margin-bottom: 15px;
  box-sizing: border-box;
}
.popup-content button {
  padding: 8px 15px;
  margin-right: 10px;
}

/* === –ù–ê–°–¢–†–û–ô–ö–ò === */
.settings-group {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.settings-group h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  color: #495057;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 6px;
}

.setting-item {
  display: flex;
  align-items: flex-start;
  margin-bottom: 12px;
  padding: 4px 0;
}

.setting-item:last-child {
  margin-bottom: 0;
}

.setting-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin-right: 12px;
  margin-top: 2px;
  cursor: pointer;
  flex-shrink: 0;
}

.setting-item label {
  font-size: 15px;
  cursor: pointer;
  color: #212529;
  line-height: 1.4;
  user-select: none;
  flex: 1;
}

#settings-popup .popup-content {
  width: 420px;
  max-width: 90vw;
  padding: 20px 25px;
}

#settings-popup h3 {
  margin: 0 0 20px 0;
  font-size: 20px;
  color: #007cba;
  border-bottom: 2px solid #007cba;
  padding-bottom: 8px;
}

#close-settings-btn {
  width: 100%;
  padding: 10px;
  background-color: #007cba;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.2s;
}

#close-settings-btn:hover {
  background-color: #005a8c;
}

/* === –°–ü–†–ê–í–ö–ê - –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö === */
.help-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 15px;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 8px;
}

.help-tab {
  padding: 6px 12px;
  background-color: #f8f9fa;
  border: 1px solid #ced4da;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
  white-space: nowrap;
}

.help-tab:hover {
  background-color: #e9ecef;
}

.help-tab.active {
  background-color: #007cba;
  border-color: #007cba;
  color: white;
}

.help-tab-content {
  display: none;
  padding: 10px 5px;
}

.help-tab-content.active {
  display: block;
}

.help-section {
  max-width: 100%;
  overflow-x: hidden;
}

.help-section h3 {
  color: #007cba;
  border-bottom: 1px solid #ccc;
  padding-bottom: 8px;
  margin-top: 0;
  margin-bottom: 16px;
  font-size: 18px;
}

.help-section h4 {
  margin: 16px 0 8px 0;
  font-size: 16px;
  color: #495057;
}

.help-section p, .help-section ul {
  margin: 8px 0;
  line-height: 1.5;
}

.help-section ul {
  padding-left: 20px;
}

.help-section li {
  margin-bottom: 5px;
}

.help-section code {
  background-color: #f0f0f0;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  border: 1px solid #ddd;
}

.help-section kbd {
  background-color: #f8f9fa;
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.example-box {
  background-color: #f1f8ff;
  border-left: 4px solid #007cba;
  padding: 10px 15px;
  margin: 10px 0;
  border-radius: 0 4px 4px 0;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

.help-card {
  background-color: white;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.help-card h4 {
  margin-top: 0;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-icon {
  font-size: 20px;
}

.help-section .shortcuts-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 14px;
}

.help-section .shortcuts-table th {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  padding: 8px;
  text-align: left;
}

.help-section .shortcuts-table td {
  border: 1px solid #dee2e6;
  padding: 8px;
}

#help-popup .popup-content {
  width: 700px;
  max-width: 95vw;
  height: 550px;
  padding: 15px 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#help-popup .help-tabs {
  flex-shrink: 0;
  margin-bottom: 12px;
}

#help-popup .help-tab-content {
  flex: 1;
  overflow-y: auto;
  padding-right: 8px;
  scrollbar-width: thin;
}

#help-popup .help-section h3 {
  font-size: 16px;
  margin-bottom: 12px;
  padding-bottom: 6px;
}

#help-popup .help-section h4 {
  font-size: 14px;
  margin: 12px 0 6px 0;
}

#help-popup .help-section p,
#help-popup .help-section ul {
  font-size: 13px;
  margin: 6px 0;
  line-height: 1.4;
}

#help-popup .help-section li {
  margin-bottom: 3px;
}

#help-popup .help-section code {
  font-size: 12px;
  padding: 2px 5px;
}

#help-popup .help-section kbd {
  font-size: 11px;
  padding: 2px 5px;
}

#help-popup .help-card {
  padding: 10px 12px;
  margin-bottom: 10px;
  border-radius: 4px;
}

#help-popup .help-card h4 {
  margin-bottom: 6px;
}

#help-popup .help-card:last-child {
  margin-bottom: 0;
}

#help-popup .example-box {
  padding: 8px 12px;
  margin: 8px 0;
  font-size: 12px;
  border-left-width: 3px;
}

#help-popup .shortcuts-table {
  font-size: 12px;
  margin: 10px 0;
}

#help-popup .shortcuts-table th,
#help-popup .shortcuts-table td {
  padding: 6px;
  font-size: 12px;
}

#close-help-btn {
  width: 100%;
  padding: 8px;
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 15px;
  flex-shrink: 0;
  transition: background-color 0.2s;
}

#close-help-btn:hover {
  background-color: #5a6268;
}

.scan-btn {
  padding: 4px 8px;
  background-color: #ffc107;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  font-size: 14px;
}
.scan-btn:hover {
  background-color: #e0a800;
}
</style>
</head>
<body>
<div class="app-header">
  <div class="app-title" id="animated-title">NoteWarp</div>
</div>
<div class="tabs">
  <div class="tab-buttons-container">
    <button class="tab-button active" data-tab="editor-tab">–†–µ–¥–∞–∫—Ç–æ—Ä</button>
    <button class="tab-button" data-tab="dictionary-tab">–°–ª–æ–≤–∞—Ä—å</button>
  </div>
  <div class="header-controls">
    <button class="settings-button" id="settings-button">‚öôÔ∏è</button>
    <button class="help-button" id="help-button">[?]</button>
  </div>
</div>

<div id="editor-tab" class="active">
  <textarea id="editor" style="width:100%; height:400px; font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
  
  <div class="tools-panel">
    <button id="scan-replace-btn" class="tool-btn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∑–∞–º–µ–Ω—ã">
      üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—ë
    </button>
  </div>
  
  <div class="save-panel">
    <div class="save-controls">
      <input type="text" class="filename-input" id="filename-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)">
      <button class="save-button" id="save-file-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="filename-error" id="filename-error"></div>
  </div>
</div>

<div id="dictionary-tab">
  <div class="dictionary-manager">
    <div class="shortcuts-list">
      <div class="dictionary-panel">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è–º–∏</h3>
        <div class="dictionaries-list-container">
          <table class="dictionaries-table">
            <thead>
              <tr>
                <th>–í–∫–ª</th>
                <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="dictionaries-table-body">
            </tbody>
          </table>
          <div id="conflict-status" class="conflict-status"></div>
        </div>
        
        <div class="drop-zone" id="drop-zone">
          –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å–ª–æ–≤–∞—Ä—è (TXT) —Å—é–¥–∞
        </div>
      </div>
      
      <div class="editing-dict-panel">
        <h3 id="editing-dict-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è</h3>
        <div class="shortcut-table-container">
          <table class="shortcut-table">
            <thead>
              <tr>
                <th>–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ</th>
                <th>–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞</th>
              </tr>
            </thead>
            <tbody id="shortcuts-table-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="replacement-editor">
      <div class="editing-substitution-panel">
        <div class="shortcut-edit-field">
          <label for="edit-shortcut">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ:</label>
          <input type="text" id="edit-shortcut" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ">
          <div class="error-message" id="shortcut-error"></div>
        </div>
        <div class="replacement-edit-field">
          <label for="edit-replacement">–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞:</label>
          <textarea id="edit-replacement" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏"></textarea>
        </div>
        <div class="editor-buttons">
          <button id="delete-shortcut-btn" class="delete" disabled>–£–¥–∞–ª–∏—Ç—å</button>
          <button id="save-shortcut-btn" class="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div id="settings-popup" class="popup-overlay" style="display:none;">
  <div class="popup-content">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    
    <div class="settings-group">
      <h4>–†–µ–¥–∞–∫—Ç–æ—Ä</h4>
      <div class="setting-item">
        <input type="checkbox" id="word-wrap-checkbox">
        <label for="word-wrap-checkbox">–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ —Å–ª–æ–≤–∞–º)</label>
      </div>
    </div>
    
    <div class="settings-group">
      <h4>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ</h4>
      <div class="setting-item">
        <input type="checkbox" id="feedback-sound-checkbox">
        <label for="feedback-sound-checkbox">–ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª</label>
      </div>
      <div class="setting-item">
        <input type="checkbox" id="feedback-visual-checkbox">
        <label for="feedback-visual-checkbox">–í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–º–∏–≥–∞–Ω–∏–µ —Ñ–æ–Ω–∞)</label>
      </div>
    </div>
    
    <button id="close-settings-btn">–ì–æ—Ç–æ–≤–æ</button>
  </div>
</div>

<!-- –°–ø—Ä–∞–≤–∫–∞ -->
<div id="help-popup" class="popup-overlay" style="display:none;">
  <div class="popup-content help-popup">
    <div class="help-tabs">
      <button class="help-tab" data-tab="help-editor">üìù –†–µ–¥–∞–∫—Ç–æ—Ä</button>
      <button class="help-tab" data-tab="help-dictionary">üìö –°–ª–æ–≤–∞—Ä—å</button>
      <button class="help-tab" data-tab="help-shortcuts">‚å®Ô∏è –•–æ—Ç–∫–µ–∏</button>
	  <button class="help-tab active" data-tab="help-quickstart">üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</button>
      <button class="help-tab" data-tab="help-about">‚ÑπÔ∏è –û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
    </div>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç -->
    <div class="help-tab-content active" id="help-quickstart-tab">
      <div class="help-section">

        <div class="help-card">
          <p>–í–≤–µ–¥–∏—Ç–µ –≤ –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ <code>—Ç–µ—Å—Ç\</code> –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.</p>
        </div>
        
        <!-- –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø—Ä–æ —Å–ª–æ–≤–∞—Ä—å -->
        <div class="help-card" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">
          <strong>üìå –í–∞–∂–Ω–æ:</strong> –ß—Ç–æ–±—ã —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ <code>—Ç–µ—Å—Ç\</code> —Å—Ä–∞–±–æ—Ç–∞–ª–æ, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ª–æ–≤–∞—Ä—å <strong>¬´default¬ª</strong> –≤–∫–ª—é—á—ë–Ω (–≥–∞–ª–æ—á–∫–∞ –Ω–∞–ø—Ä–æ—Ç–∏–≤ –Ω–µ–≥–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–°–ª–æ–≤–∞—Ä—å¬ª).
        </div>
        
      </div>
    </div>
    
    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
    <div class="help-tab-content" id="help-editor-tab">
      <div class="help-section">
        <p>–û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º.</p>
        
        <h4>–ê–≤—Ç–æ–∑–∞–º–µ–Ω–∞</h4>
        <p>–°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ.</p>
        <div class="example-box">
          <code>hello ‚Üí –ø—Ä–∏–≤–µ—Ç</code>
        </div>
        
        <h4>–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ –º–µ—Ç–∫–∞–º</h4>
        <p>–ù–∞–∂–º–∏—Ç–µ <kbd>Alt+X</kbd> –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–∏–º–≤–æ–ª—É <code>*</code>.</p>
        
        <h4>–ú–∞—Ä–∫–µ—Ä—ã —Ä–∞–∑–¥–µ–ª–æ–≤</h4>
        <ul>
          <li><kbd>Ctrl+1‚Ä¶9</kbd> ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–∑–¥–µ–ª—É</li>
          <li><kbd>Ctrl+Alt+1‚Ä¶9</kbd> ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª</li>
          <li><kbd>Ctrl+0</kbd> ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã</li>
        </ul>
      </div>
    </div>
    
    <!-- –°–ª–æ–≤–∞—Ä—å -->
    <div class="help-tab-content" id="help-dictionary-tab">
      <div class="help-section">
        <p>–°–ª–æ–≤–∞—Ä–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –∏—Ö –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏.</p>
        
        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è–º–∏</h4>
        <ul>
          <li><strong>–ß–µ–∫–±–æ–∫—Å—ã</strong> ‚Äî –≤–∫–ª—é—á–∞—é—Ç/–æ—Ç–∫–ª—é—á–∞—é—Ç —Å–ª–æ–≤–∞—Ä–∏</li>
          <li><strong>–≠–∫—Å–ø–æ—Ä—Ç</strong> ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –≤ —Ñ–∞–π–ª</li>
          <li><strong>–£–¥–∞–ª–∏—Ç—å</strong> ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å</li>
        </ul>
        
        <h4>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è</h4>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª .txt —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º <code>{}</code>, –ø–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–º –∏–º–µ–Ω–µ–º –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ –∑–æ–Ω—É –∏–º–ø–æ—Ä—Ç–∞.</p>
        
        <h4>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è</h4>
        <p>–í–≤–µ–¥–∏—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏, –Ω–∞–∂–º–∏—Ç–µ <strong>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</strong>.</p>
		
        <h4>–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏</h4>
        <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –≤ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–µ, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è:</p>
        <table class="shortcuts-table">
          <thead>
            <tr><th>–¢–µ–≥</th><th>–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è</th></tr>
          </thead>
          <tbody>
            <tr><td><code>[–¥–∞—Ç–∞]</code></td><td>14.02.2026</td></tr>
            <tr><td><code>[–¥–∞—Ç–∞_iso]</code></td><td>2026-02-14</td></tr>
            <tr><td><code>[–≤—Ä–µ–º—è]</code></td><td>14:30</td></tr>
            <tr><td><code>[–≤—Ä–µ–º—è_iso]</code></td><td>14:30:22</td></tr>
          </tbody>
        </table>
        
        <h4>–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π</h4>
        <p>–ï—Å–ª–∏ –æ–¥–Ω–æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä—è—Ö, –æ–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∂—ë–ª—Ç–æ–π –ø–æ–ª–æ—Å–æ–π.</p>
      </div>
    </div>
    
    <!-- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ -->
    <div class="help-tab-content" id="help-shortcuts-tab">
      <div class="help-section">
        <table class="shortcuts-table">
          <thead>
            <tr><th>–ö–ª–∞–≤–∏—à–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
          </thead>
          <tbody>
            <tr><td><kbd>Alt+X</kbd></td><td>–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É <code>*</code></td></tr>
            <tr><td><kbd>Ctrl+1‚Ä¶9</kbd></td><td>–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–∑–¥–µ–ª—É</td></tr>
            <tr><td><kbd>Ctrl+Alt+1‚Ä¶9</kbd></td><td>–í—ã–¥–µ–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª</td></tr>
            <tr><td><kbd>Ctrl+0</kbd></td><td>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã</td></tr>
            <tr><td><kbd>Ctrl+Z</kbd> / <kbd>Ctrl+–Ø</kbd></td><td>–û—Ç–º–µ–Ω–∞</td></tr>
            <tr><td><kbd>Ctrl+Y</kbd> / <kbd>Ctrl+–ù</kbd></td><td>–ü–æ–≤—Ç–æ—Ä</td></tr>
            <tr><td><kbd>Pause</kbd></td><td>–°–º–µ–Ω–∏—Ç—å —Ä–∞—Å–∫–ª–∞–¥–∫—É –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</td></tr>
            <tr><td><kbd>Tab</kbd></td><td>–í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- –û –ø—Ä–æ–≥—Ä–∞–º–º–µ -->
    <div class="help-tab-content" id="help-about-tab">
      <div class="help-section">
        
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 48px; opacity: 0.8;">üìù‚ö°</div>
          <div style="font-size: 24px; font-weight: bold; color: #007cba;">NoteWarp</div>
          <div style="color: #6c757d;">–í–µ—Ä—Å–∏—è 5.1 (—Ñ–µ–≤—Ä–∞–ª—å 2026)</div>
        </div>
        
        <div class="help-card">
          <p>–õ–æ–∫–∞–ª—å–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.</p>
        </div>
        
        <div class="help-card">
          <h4>üë• –ê–≤—Ç–æ—Ä—ã –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</h4>
          <p><strong>–ê–≤—Ç–æ—Ä:</strong> –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–∞—Ä–∫–∞–≤—Ü–µ–≤</p>
          <p><strong>–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ–º–æ—â—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:</strong></p>
          <ul>
            <li><strong>Qwen</strong> ‚Äî –∑–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –∫–æ–¥–æ–º</li>
            <li><strong>–ê–ª–∏—Å–∞(Yandex GPT), DeepSeek</strong> ‚Äî –∑–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é</li>
          </ul>
        </div>
        
        <div class="help-card">
          <h4>üîí –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?</h4>
          <p>–ü–µ—Ä–µ–¥ –≤–∞–º–∏ –æ–±—ã—á–Ω—ã–π HTML‚Äë—Ñ–∞–π–ª —Å JavaScript. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç ¬´—á—ë—Ä–Ω—ã—Ö —è—â–∏–∫–æ–≤¬ª (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏–ª–∏ –æ–Ω–ª–∞–π–Ω‚Äë—Å–µ—Ä–≤–∏—Å–æ–≤), –∑–¥–µ—Å—å:</p>
          <ul>
            <li>‚úÖ –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤;</li>
            <li>‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ - –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ç–∏;</li>
			<li>‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞ - –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å;</li>
            <li>‚úÖ –§–∞–π–ª –∏ —Å–ª–æ–≤–∞—Ä–∏ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Ñ–ª–µ—à–∫–µ, –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–∞ –ª—é–±–æ–º –ü–ö</li>
          </ul>
        </div>
        
        <div class="help-card">
          <h4>üì¶ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∏ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏</h4>
          <p>–ü—Ä–æ–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ GitHub. –ù–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –≤–¥—Ä—É–≥ –ø–æ—è–≤—è—Ç—Å—è) –±—É–¥—É—Ç —Ç–∞–º –∂–µ.</p>
          <p style="text-align: center;">
            <a href="https://github.com/GAV-UltraVibes/NoteWarp" target="_blank" style="display: inline-block; padding: 8px 20px; background-color: #24292e; color: white; text-decoration: none; border-radius: 4px;">GitHub</a>
          </p>
        </div>
        
        <div class="help-card">
          <h4>üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è</h4>
          <p>–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ MIT. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å.</p>
          <p style="font-family: monospace; font-size: 12px; background-color: #f5f5f5; padding: 8px;">MIT License ¬© 2024-2026 –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–∞—Ä–∫–∞–≤—Ü–µ–≤</p>
        </div>
        
        <div style="text-align: center; margin-top: 20px; color: #777; font-size: 12px;">
          –°–¥–µ–ª–∞–Ω–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ü–µ–Ω–∏—Ç —Å–≤–æ—ë –≤—Ä–µ–º—è.
        </div>
      </div>
    </div>
    
    <button id="close-help-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
// ============================================================================
// –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è NoteWarp
// ============================================================================

class DOMUtils {
  static showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
  }

  static clearError(element) {
    element.style.display = 'none';
  }

  static createTagInputPopup(callback) {
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.innerHTML = `
      <div class="popup-content">
        <h3>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Ä–∫–µ—Ä–∞</h3>
        <input type="text" id="tag-input" placeholder="–ò–º—è –º–∞—Ä–∫–µ—Ä–∞">
        <button id="popup-ok-btn">–û–∫</button>
        <button id="popup-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `;
    document.body.appendChild(overlay);

    const input = document.getElementById('tag-input');
    const okBtn = document.getElementById('popup-ok-btn');
    const cancelBtn = document.getElementById('popup-cancel-btn');

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        const name = input.value.trim();
        if (name.includes(' ')) {
          alert('–ò–º—è –º–∞—Ä–∫–µ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã.');
          return;
        }
        if (name) {
          callback(name);
        }
        document.body.removeChild(overlay);
        document.getElementById('editor').focus();
      }
    });

    okBtn.addEventListener('click', () => {
      const name = input.value.trim();
      if (name.includes(' ')) {
        alert('–ò–º—è –º–∞—Ä–∫–µ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã.');
        return;
      }
      if (name) {
        callback(name);
      }
      document.body.removeChild(overlay);
      document.getElementById('editor').focus();
    });

    cancelBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      document.getElementById('editor').focus();
    });

    input.focus();
  }

  static createHelpPopup(contentHTML, callback) {
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.innerHTML = `
      <div class="popup-content">
        <div class="help-content">${contentHTML}</div>
        <button id="popup-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
    document.body.appendChild(overlay);

    const closeBtn = document.getElementById('popup-close-btn');
    closeBtn.addEventListener('click', () => {
      document.body.removeChild(overlay);
      if (callback) callback();
    });
  }
}

class FeedbackManager {
  constructor() {
    this.soundEnabled = false;
    this.visualEnabled = false;
    this.audioContext = null;
    this.loadSettings();
    this.setupUI();
  }

  setupUI() {
    const soundCheckbox = document.getElementById('feedback-sound-checkbox');
    const visualCheckbox = document.getElementById('feedback-visual-checkbox');
    
    if (soundCheckbox && visualCheckbox) {
      soundCheckbox.checked = this.soundEnabled;
      visualCheckbox.checked = this.visualEnabled;
      
      soundCheckbox.addEventListener('change', (e) => {
        this.soundEnabled = e.target.checked;
        this.saveSettings();
      });
      
      visualCheckbox.addEventListener('change', (e) => {
        this.visualEnabled = e.target.checked;
        this.saveSettings();
      });
    }
  }

  loadSettings() {
    const saved = localStorage.getItem('noteWarpFeedbackSettings');
    if (saved) {
      try {
        const settings = JSON.parse(saved);
        this.soundEnabled = settings.sound || false;
        this.visualEnabled = settings.visual || false;
      } catch (e) {
        console.warn('Could not load feedback settings, using defaults.');
      }
    }
  }

  saveSettings() {
    const settings = {
      sound: this.soundEnabled,
      visual: this.visualEnabled
    };
    localStorage.setItem('noteWarpFeedbackSettings', JSON.stringify(settings));
  }

  initAudio() {
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  playSound() {
    this.initAudio();
    const ctx = this.audioContext;
    const now = ctx.currentTime;
    const duration = 0.12;
    
    const oscillator = ctx.createOscillator();
    const gain = ctx.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(180, now);
    oscillator.frequency.exponentialRampToValueAtTime(280, now + duration);
    
    gain.gain.setValueAtTime(0.01, now);
    gain.gain.linearRampToValueAtTime(0.08, now + duration);
    gain.gain.setValueAtTime(0.08, now + duration);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration + 0.02);
    
    oscillator.connect(gain);
    gain.connect(ctx.destination);
    
    oscillator.start(now);
    oscillator.stop(now + duration + 0.02);
  }

  triggerWarp() {
    const body = document.body;
    const originalBg = getComputedStyle(body).backgroundColor || '#ffffff';
    body.style.backgroundColor = 'rgba(0, 0, 0, 0.04)';
    setTimeout(() => {
      body.style.backgroundColor = originalBg;
    }, 100);
  }

  triggerFeedback() {
    if (this.soundEnabled) {
      this.playSound();
    }
    if (this.visualEnabled) {
      this.triggerWarp();
    }
  }
}

class TextManipulator {
  static insertTextAtCursor(text, element) {
    const startPos = element.selectionStart;
    const endPos = element.selectionEnd;
    const before = element.value.substring(0, startPos);
    const after = element.value.substring(endPos);
    element.value = before + text + after;
    element.setSelectionRange(startPos + text.length, startPos + text.length);
  }
}

class AutoReplacer {
  constructor(dictionaryManager, maxBufferSize = 50) {
    this.dictionaryManager = dictionaryManager;
    this.maxBufferSize = maxBufferSize;
  }

  updateBuffer(buffer, text) {
    buffer += text;
    if (buffer.length > this.maxBufferSize) {
      buffer = buffer.slice(-this.maxBufferSize);
    }
    return buffer;
  }

  checkAndReplace(buffer, element, insertCallback) {
    const dictionary = this.dictionaryManager.getActiveDictionary();
    const sortedKeys = Object.keys(dictionary).sort((a, b) => b.length - a.length);
    
    for (let word of sortedKeys) {
      if (buffer.endsWith(word)) {
        const replacement = dictionary[word];
        insertCallback(word, replacement);
        return true;
      }
    }
    return false;
  }
}

class HistoryManager {
  constructor(maxSize = 100) {
    this.history = [];
    this.index = -1;
    this.maxSize = maxSize;
  }

  pushState(state) {
    if (this.index < this.history.length - 1) {
      this.history = this.history.slice(0, this.index + 1);
    }
    this.history.push(state);
    this.index++;
    if (this.history.length > this.maxSize) {
      this.history.shift();
      this.index--;
    }
  }

  undo() {
    if (this.index > 0) {
      this.index--;
      return this.history[this.index];
    }
    return null;
  }

  redo() {
    if (this.index < this.history.length - 1) {
      this.index++;
      return this.history[this.index];
    }
    return null;
  }
}

/**
 * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
 */
class DateTimeUtils {
  static replaceDateTimeTags(text) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const dateISO = now.toISOString().split('T')[0];
    
    return text
      .replace(/\[–¥–∞—Ç–∞\]/g, now.toLocaleDateString())
      .replace(/\[–¥–∞—Ç–∞_iso\]/g, dateISO)
      .replace(/\[–≤—Ä–µ–º—è\]/g, `${hours}:${minutes}`)
      .replace(/\[–≤—Ä–µ–º—è_iso\]/g, `${hours}:${minutes}:${seconds}`)
      .replace(/\[–¥–∞—Ç–∞_–≤—Ä–µ–º—è\]/g, `${dateISO} ${hours}:${minutes}`)
      .replace(/\[–¥–∞—Ç–∞_–≤—Ä–µ–º—è_–ª–æ–∫\]/g, `${now.toLocaleDateString()}, ${hours}:${minutes}:${seconds}`);
  }
}

class TextEditor {
  constructor(element, dictManager, feedbackManager) {
    this.editor = element;
    this.dictionaryManager = dictManager;
    this.feedbackManager = feedbackManager;
    this.lastSearchPositions = {};
    this.inputBuffer = "";
    this.isUndoRedoOperation = false;
    this.autoReplacer = new AutoReplacer(dictManager);
    this.historyManager = new HistoryManager(100);
    
    this.setupEventListeners();
    this.setupWordWrap();
    this.loadWordWrapSetting();
    this.setupSaveFunctionality();
    this.setInitialFilename();
    this.saveHistoryState();
  }

  loadWordWrapSetting() {
    const saved = localStorage.getItem('noteWarpWordWrap');
    if (saved !== null) {
      const enabled = saved === 'true';
      const checkbox = document.getElementById('word-wrap-checkbox');
      if (checkbox) {
        checkbox.checked = enabled;
        this.editor.wrap = enabled ? 'soft' : 'off';
      }
    }
  }

  setupWordWrap() {
    const checkbox = document.getElementById('word-wrap-checkbox');
    checkbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        this.editor.wrap = 'soft';
      } else {
        this.editor.wrap = 'off';
      }
      localStorage.setItem('noteWarpWordWrap', e.target.checked);
    });
  }

  setupEventListeners() {
    this.editor.addEventListener('keydown', (e) => this.handleKeyDown(e));
    this.editor.addEventListener('input', (e) => this.handleInput(e));
    this.editor.addEventListener('paste', (e) => this.handlePaste(e));

    const scanBtn = document.getElementById('scan-replace-btn');
    if (scanBtn) {
      scanBtn.addEventListener('click', () => this.scanAndReplaceAll());
    }
  }

  /**
   * –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –∑–∞–º–µ–Ω –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥
   */
  scanAndReplaceAll() {
    this.saveHistoryState();
    
    let content = this.editor.value;
    const originalCursorPos = this.getCursorPosition();
    let cursorPos = originalCursorPos;
    
    const dictionary = this.dictionaryManager.getActiveDictionary();
    if (Object.keys(dictionary).length === 0) {
      this.feedbackManager.triggerFeedback();
      return;
    }
    
    const sortedKeys = Object.keys(dictionary).sort((a, b) => b.length - a.length);
    let i = 0;
    let totalReplacements = 0;
    
    while (i < content.length) {
      let replaced = false;
      for (let word of sortedKeys) {
        if (content.substring(i).startsWith(word)) {
          let replacement = dictionary[word];
          
          // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–≥–∏ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –î–õ–Ø –ö–ê–ñ–î–û–ì–û –°–û–ö–†–ê–©–ï–ù–ò–Ø
          replacement = DateTimeUtils.replaceDateTimeTags(replacement);
          
          const cursorMarkPos = replacement.indexOf('[–∫—É—Ä—Å–æ—Ä]');
          let cleanReplacement = replacement;
          
          if (cursorMarkPos !== -1) {
            cleanReplacement = replacement.replace('[–∫—É—Ä—Å–æ—Ä]', '');
            if (i <= cursorPos && cursorPos <= i + word.length) {
              cursorPos = i + cursorMarkPos;
            } else if (cursorPos > i) {
              cursorPos += (cleanReplacement.length - word.length);
            }
          } else {
            if (cursorPos > i) {
              cursorPos += (cleanReplacement.length - word.length);
            }
          }
          
          content = content.substring(0, i) + cleanReplacement + content.substring(i + word.length);
          i += cleanReplacement.length;
          totalReplacements++;
          replaced = true;
          break;
        }
      }
      if (!replaced) i++;
    }
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Ç–µ–≥–æ–≤ –≤–æ –≤—Å—ë–º —Ç–µ–∫—Å—Ç–µ
    content = DateTimeUtils.replaceDateTimeTags(content);
    
    this.editor.value = content;
    this.setCursorPosition(Math.max(0, Math.min(cursorPos, content.length)));
    this.feedbackManager.triggerFeedback();
    console.log(`–í—ã–ø–æ–ª–Ω–µ–Ω–æ ${totalReplacements} –∑–∞–º–µ–Ω`);
  }

  setupSaveFunctionality() {
    const saveBtn = document.getElementById('save-file-btn');
    const filenameInput = document.getElementById('filename-input');
    
    filenameInput.addEventListener('blur', () => {
      const currentFilename = filenameInput.value;
      const processedFilename = this.processFilenameTemplate(currentFilename);
      if (processedFilename !== currentFilename) {
        filenameInput.value = processedFilename;
      }
    });
    
    saveBtn.addEventListener('click', () => this.saveFile());
    filenameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.saveFile();
    });
  }

  setInitialFilename() {
    const now = new Date();
    const isoDate = now.toISOString().split('T')[0];
    const time = now.toTimeString().split(' ')[0].substring(0, 5).replace(':', '-');
    const defaultFilename = isoDate + ' ' + time;
    document.getElementById('filename-input').value = defaultFilename;
  }

  saveFile() {
    let filename = document.getElementById('filename-input').value.trim();
    const errorElement = document.getElementById('filename-error');
    
    filename = this.processFilenameTemplate(filename);
    
    if (!filename) {
      DOMUtils.showError(errorElement, '–ò–º—è —Ñ–∞–π–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      return;
    }
    
    const invalidChars = /[<>:"/\\|?*\x00-\x1F]/;
    if (invalidChars.test(filename)) {
      DOMUtils.showError(errorElement, '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã');
      return;
    }
    
    if (filename.length > 255) {
      DOMUtils.showError(errorElement, '–ò–º—è —Ñ–∞–π–ª–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ');
      return;
    }
    
    DOMUtils.clearError(errorElement);
    const content = this.editor.value;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  saveHistoryState() {
    const content = this.editor.value;
    const cursorPos = this.getCursorPosition();
    this.historyManager.pushState({ content, cursorPos });
  }

  undo() {
    const state = this.historyManager.undo();
    if (state) {
      this.isUndoRedoOperation = true;
      this.editor.value = state.content;
      this.setCursorPosition(state.cursorPos);
      setTimeout(() => this.isUndoRedoOperation = false, 0);
    }
  }

  redo() {
    const state = this.historyManager.redo();
    if (state) {
      this.isUndoRedoOperation = true;
      this.editor.value = state.content;
      this.setCursorPosition(state.cursorPos);
      setTimeout(() => this.isUndoRedoOperation = false, 0);
    }
  }

  getCursorPosition() {
    return this.editor.selectionStart;
  }

  setCursorPosition(position) {
    this.editor.setSelectionRange(position, position);
  }

  selectText(start, end) {
    this.editor.setSelectionRange(start, end);
  }

  handleKeyDown(e) {
    if (e.ctrlKey) {
      const isDigit = e.key >= '0' && e.key <= '9';
      const isStar = e.key === '*';
      
      if (isDigit || isStar) {
        e.preventDefault();
        
        if (e.altKey) {
          if (isDigit) {
            if (e.key === '0') return;
            this.navigateToTag(e.key, true);
          } else {
            TextEditor.currentAction = 'select';
            DOMUtils.createTagInputPopup((name) => {
              this.navigateToNamedTag(name, true);
            });
          }
        } else {
          if (isDigit) {
            if (e.key === '0') {
              this.removeAllMarkers();
              return;
            }
            this.navigateToTag(e.key, false);
          } else {
            TextEditor.currentAction = 'move';
            DOMUtils.createTagInputPopup((name) => {
              this.navigateToNamedTag(name, false);
            });
          }
        }
        return;
      }
    }
    
    if (e.ctrlKey && (e.key === 'z' || e.key === '—è')) {
      e.preventDefault();
      if (e.shiftKey) this.redo(); else this.undo();
      return;
    }
    
    if (e.ctrlKey && (e.key === 'y' || e.key === '–Ω')) {
      e.preventDefault();
      this.redo();
      return;
    }
    
    if (e.key === 'Tab') {
      e.preventDefault();
      this.insertText('\t');
      return;
    }
    
    if (e.altKey && (e.key === 'x' || e.key === '—á')) {
      e.preventDefault();
      this.findAndSelectNext('*', 'star');
      return;
    }
    
    if (e.key === 'Pause') {
      e.preventDefault();
      this.toggleCyrillicSelection();
      return;
    }
    
    if (e.key === 'Backspace' || e.key === 'Delete') {
      if (!this.isUndoRedoOperation) this.saveHistoryState();
    }
  }

  handleInput(e) {
    if (this.isUndoRedoOperation) return;
    
    const text = e.data || '';
    if (text) {
      this.inputBuffer = this.autoReplacer.updateBuffer(this.inputBuffer, text);
      
      if (!this.autoReplacer.checkAndReplace(this.inputBuffer, this.editor, (word, replacement) => {
        this.performAutoReplace(word, replacement);
      })) {
        setTimeout(() => this.saveHistoryState(), 0);
      }
    } else {
      setTimeout(() => this.saveHistoryState(), 0);
    }
  }

  handlePaste() {
    if (!this.isUndoRedoOperation) setTimeout(() => this.saveHistoryState(), 0);
  }

  /**
   * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–º–µ–Ω—ã —Å –∑–∞–º–µ–Ω–æ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ–≥–æ–≤
   */
  performAutoReplace(word, replacement) {
    this.saveHistoryState();
    const startPos = this.editor.selectionStart;
    const endPos = this.editor.selectionEnd;
    const startOfWord = Math.max(0, startPos - word.length);
    const textBefore = this.editor.value.substring(0, startOfWord);
    const textAfter = this.editor.value.substring(endPos);
    
    // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–≥–∏ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    replacement = DateTimeUtils.replaceDateTimeTags(replacement);
    
    const cursorMarkPos = replacement.indexOf('[–∫—É—Ä—Å–æ—Ä]');
    let cleanReplacement = replacement;
    let newCursorPos = startOfWord + replacement.length;
    
    if (cursorMarkPos !== -1) {
      cleanReplacement = replacement.replace('[–∫—É—Ä—Å–æ—Ä]', '');
      newCursorPos = startOfWord + cursorMarkPos;
    }
    
    this.editor.value = textBefore + cleanReplacement + textAfter;
    this.editor.setSelectionRange(newCursorPos, newCursorPos);
    this.inputBuffer = "";
    
    this.feedbackManager.triggerFeedback();
  }

  insertText(text) {
    if (!this.isUndoRedoOperation) this.saveHistoryState();
    const startPos = this.getCursorPosition();
    const before = this.editor.value.substring(0, startPos);
    const after = this.editor.value.substring(startPos);
    this.editor.value = before + text + after;
    this.setCursorPosition(startPos + text.length);
    this.inputBuffer = this.autoReplacer.updateBuffer(this.inputBuffer, text);
  }

  findAndSelectNext(char, searchKey) {
    const content = this.editor.value;
    const cursorPos = this.getCursorPosition();
    let nextPos = content.indexOf(char, cursorPos + 1);
    
    if (nextPos === -1) nextPos = content.indexOf(char, 0);
    
    if (nextPos !== -1) {
      this.selectText(nextPos, nextPos + 1);
      this.lastSearchPositions[searchKey] = nextPos;
      this.feedbackManager.triggerFeedback();
    }
  }

  navigateToTag(tag, shouldSelect = false) {
    const positions = this.findTagPairPositions(tag);
    if (positions) {
      const { openingEnd, closingStart } = positions;
      if (shouldSelect) {
        this.selectText(openingEnd, closingStart);
      } else {
        this.setCursorPosition(closingStart);
      }
      this.feedbackManager.triggerFeedback();
    }
  }

  navigateToNamedTag(tagName, shouldSelect = false) {
    const positions = this.findTagPairPositions(tagName);
    if (positions) {
      const { openingEnd, closingStart } = positions;
      if (shouldSelect) {
        this.selectText(openingEnd, closingStart);
      } else {
        this.setCursorPosition(closingStart);
      }
      this.feedbackManager.triggerFeedback();
    }
  }

  findTagPairPositions(tagName) {
    if (tagName.includes(' ')) {
      console.log('–ò–º—è –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª—ã, –ø–æ–∏—Å–∫ –ø–∞—Ä—ã –æ—Ç–º–µ–Ω—ë–Ω');
      return null;
    }
    
    const content = this.editor.value;
    const cursorPos = this.getCursorPosition();
    const escapedTagName = this.escapeRegExp(tagName);
    
    const openingRegex = new RegExp(`\\[${escapedTagName}>`, 'g');
    const closingRegex = new RegExp(`<${escapedTagName}\\]`, 'g');
    
    let openingMatches = [];
    let closingMatches = [];
    let match;
    
    openingRegex.lastIndex = 0;
    while ((match = openingRegex.exec(content)) !== null) {
      openingMatches.push({ start: match.index, end: match.index + match[0].length });
    }
    
    closingRegex.lastIndex = 0;
    while ((match = closingRegex.exec(content)) !== null) {
      closingMatches.push({ start: match.index, end: match.index + match[0].length });
    }
    
    let pairs = [];
    let closingIndex = 0;
    for (let opening of openingMatches) {
      while (closingIndex < closingMatches.length && closingMatches[closingIndex].start < opening.end) {
        closingIndex++;
      }
      if (closingIndex < closingMatches.length) {
        pairs.push({
          openingStart: opening.start,
          openingEnd: opening.end,
          closingStart: closingMatches[closingIndex].start,
          closingEnd: closingMatches[closingIndex].end
        });
        closingIndex++;
      }
    }
    
    pairs.sort((a, b) => a.openingStart - b.openingStart);
    if (pairs.length === 0) return null;
    
    let foundPair = null;
    for (let pair of pairs) {
      if (cursorPos >= pair.openingEnd && cursorPos <= pair.closingStart) {
        const currentIndex = pairs.indexOf(pair);
        const nextIndex = (currentIndex + 1) % pairs.length;
        foundPair = pairs[nextIndex];
        break;
      } else if (cursorPos < pair.openingStart) {
        foundPair = pair;
        break;
      }
    }
    
    if (!foundPair && pairs.length > 0) {
      const lastPair = pairs[pairs.length - 1];
      if (cursorPos > lastPair.closingEnd) {
        foundPair = pairs[0];
      }
    }
    
    return foundPair;
  }

  extractTextBetweenMarkers(tagName) {
    if (tagName.includes(' ')) {
      console.log('–ò–º—è –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª—ã, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
      return null;
    }
    
    const content = this.editor.value;
    const escapedTagName = this.escapeRegExp(tagName);
    const openingRegex = new RegExp(`\\[${escapedTagName}>`, 'g');
    const closingRegex = new RegExp(`<${escapedTagName}\\]`, 'g');
    
    let openingMatches = [];
    let closingMatches = [];
    let match;
    
    openingRegex.lastIndex = 0;
    while ((match = openingRegex.exec(content)) !== null) {
      openingMatches.push({ start: match.index, end: match.index + match[0].length });
    }
    
    closingRegex.lastIndex = 0;
    while ((match = closingRegex.exec(content)) !== null) {
      closingMatches.push({ start: match.index, end: match.index + match[0].length });
    }
    
    let pairs = [];
    let closingIndex = 0;
    for (let opening of openingMatches) {
      while (closingIndex < closingMatches.length && closingMatches[closingIndex].start < opening.end) {
        closingIndex++;
      }
      if (closingIndex < closingMatches.length) {
        pairs.push({
          openingEnd: opening.end,
          closingStart: closingMatches[closingIndex].start
        });
        closingIndex++;
      }
    }
    
    if (pairs.length > 0) {
      const pair = pairs[0];
      return content.substring(pair.openingEnd, pair.closingStart);
    }
    return null;
  }

  processFilenameTemplate(filename) {
    const tagRegex = /\[\[([^\[\]]+)\]\]/g;
    let processedFilename = filename;
    let match;
    
    while ((match = tagRegex.exec(filename)) !== null) {
      const fullTag = match[0];
      const tagName = match[1];
      const extractedText = this.extractTextBetweenMarkers(tagName);
      
      if (extractedText !== null) {
        processedFilename = processedFilename.replace(fullTag, extractedText);
        tagRegex.lastIndex = 0;
        filename = processedFilename;
      } else {
        tagRegex.lastIndex = 0;
      }
    }
    
    return processedFilename;
  }

  removeAllMarkers() {
    this.saveHistoryState();
    const content = this.editor.value;
    const markerRegex = /\[[^<>\[\]\s]+>|<[^<>\[\]\s]+\]/g;
    const newContent = content.replace(markerRegex, '');
    this.editor.value = newContent;
  }

  toggleCyrillicSelection() {
    const start = this.editor.selectionStart;
    const end = this.editor.selectionEnd;
    if (start === end) return;
    
    this.saveHistoryState();
    const selectedText = this.editor.value.substring(start, end);
    const toggledText = this.swapLayout(selectedText);
    const before = this.editor.value.substring(0, start);
    const after = this.editor.value.substring(end);
    this.editor.value = before + toggledText + after;
    this.editor.setSelectionRange(start, start + toggledText.length);
  }

  swapLayout(text) {
    const enToRu = {
      'q': '–π', 'w': '—Ü', 'e': '—É', 'r': '–∫', 't': '–µ', 'y': '–Ω', 'u': '–≥', 'i': '—à', 'o': '—â', 'p': '–∑', '[': '—Ö', ']': '—ä',
      'a': '—Ñ', 's': '—ã', 'd': '–≤', 'f': '–∞', 'g': '–ø', 'h': '—Ä', 'j': '–æ', 'k': '–ª', 'l': '–¥', ';': '–∂', "'": '—ç',
      'z': '—è', 'x': '—á', 'c': '—Å', 'v': '–º', 'b': '–∏', 'n': '—Ç', 'm': '—å', ',': '–±', '.': '—é', '/': '.',
      'Q': '–ô', 'W': '–¶', 'E': '–£', 'R': '–ö', 'T': '–ï', 'Y': '–ù', 'U': '–ì', 'I': '–®', 'O': '–©', 'P': '–ó', '{': '–•', '}': '–™',
      'A': '–§', 'S': '–´', 'D': '–í', 'F': '–ê', 'G': '–ü', 'H': '–†', 'J': '–û', 'K': '–õ', 'L': '–î', ':': '–ñ', '"': '–≠',
      'Z': '–Ø', 'X': '–ß', 'C': '–°', 'V': '–ú', 'B': '–ò', 'N': '–¢', 'M': '–¨', '<': '–ë', '>': '–Æ', '?': ','
    };
    
    const ruToEn = {};
    for (const [en, ru] of Object.entries(enToRu)) {
      ruToEn[ru] = en;
    }
    
    let result = '';
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      if (enToRu[char] !== undefined) {
        result += enToRu[char];
      } else if (ruToEn[char] !== undefined) {
        result += ruToEn[char];
      } else {
        result += char;
      }
    }
    return result;
  }

  escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
}

class DictionaryManager {
  constructor() {
    this.dictionaries = this.loadDictionaries();
    this.activeDictionaries = this.loadActiveDictionaries();
    this.combinedActiveDictionary = {};
    this.conflictingShortcuts = new Set();
    this.conflictDetails = {};
    this.selectedShortcut = null;
    this.selectedDictionaryName = null;
    
    this.setupEventListeners();
    this.rebuildActiveDictionary();
    this.checkConflicts();
    this.renderShortcutsTable();
    this.renderDictionariesList();
    this.updateConflictStatus();
    this.setupDropZone();
    this.clearEditFields();
    this.updateCurrentDictNameDisplay();
  }

  loadDictionaries() {
    const saved = localStorage.getItem('textEditorDictionaries');
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ª–æ–≤–∞—Ä–µ–π:', e);
      }
    }
    const initialDict = this.loadInitialDictionary();
    return { 'default': initialDict };
  }

  loadInitialDictionary() {
    const saved = localStorage.getItem('textEditorDictionary');
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è:', e);
      }
    }
    
    return { 
	  "—Ö—ä": "[[–∫—É—Ä—Å–æ—Ä]]",
	  "–•–™": "{[–∫—É—Ä—Å–æ—Ä]}",
	  "()": "([–∫—É—Ä—Å–æ—Ä])",
	  "–º–µ—Ç–∫–∞\\": "[[–∫—É—Ä—Å–æ—Ä]><*]",
	  "hello": "–ø—Ä–∏–≤–µ—Ç",
	  "–∑–∞–ø–∏—Å—å\\": "[–¥–∞—Ç–∞_iso] [–≤—Ä–µ–º—è_iso] | [–∫—É—Ä—Å–æ—Ä]",
	  "–∂—É—Ä–Ω–∞–ª\\": "[–¥–∞—Ç–∞] [–≤—Ä–µ–º—è] | [–∫—É—Ä—Å–æ—Ä]",
	  "–ø–∏—Å—å–º–æ\\": "–î–∞—Ç–∞:\t[–¥–∞—Ç–∞]\n–í—Ä–µ–º—è:\t[–≤—Ä–µ–º—è]\n[1>–ó–∞–≥–æ–ª–æ–≤–æ–∫: [–∫—É—Ä—Å–æ—Ä]<1]\n\n[2>–¢–µ–∫—Å—Ç:<2]",
	  "–ø—Å\\": "\n\t=========== –¢–∞–±–ª–∏—Ü–∞ ===============\n\t\t—Å—Ç–æ–ª–±–µ—Ü_1\t—Å—Ç–æ–ª–±–µ—Ü_2\n\t–ø–µ—Ä–≤—ã–π\t[–∫—É—Ä—Å–æ—Ä]\t\t*\n\t–≤—Ç–æ—Ä–æ–π\t*\t\t*\n\t—Ç—Ä–µ—Ç–∏–π\t*\t\t*\n\n(–ù–∞–∂–∏–º–∞–π—Ç–µ Alt+X –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ –∑–≤—ë–∑–¥–æ—á–∫–∞–º)\n",
	  "—Ç–µ—Å—Ç\\": "\t\t–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç\n\n–ù–∞–∂–∏–º–∞–π—Ç–µ [Alt+X], —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è –ø–æ –º–µ—Å—Ç–∞–º –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π:\n–ø–µ—Ä–≤—ã–π *, –≤—Ç–æ—Ä–æ–π *, —Ç—Ä–µ—Ç–∏–π *.\n\n[—Ç>\n–†–∞–∑–¥–µ–ª –ø–µ—Ä–≤—ã–π: [1>–§—Ä–∞–≥–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Ü–µ–ª–∏–∫–æ–º [Alt+Ctrl+1] –∏–ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫—É—Ä—Å–æ—Ä –≤ –µ–≥–æ –∫–æ–Ω–µ—Ü[Ctrl+1]<1].\n\n–†–∞–∑–¥–µ–ª –≤—Ç–æ—Ä–æ–π: [2>–¢–æ –∂–µ —Å–∞–º–æ–µ, —Ç–æ–ª—å–∫–æ [Alt+Ctrl+2] –∏ [Ctrl+2]<2].\n<—Ç]\n\n–ï—Å–ª–∏ –¥–µ–≤—è—Ç–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏ –≤–∏–¥–∞ [–∏–º—è> <–∏–º—è], –≤—ã—à–µ - –ø—Ä–∏–º–µ—Ä —Ç–∞–∫–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [Ctrl+*] [Alt+Ctrl+*].\n\n–ß—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, –Ω–∞–±–µ—Ä–∏—Ç–µ \"–ø—Å\\\" –ø–æ—Å—Ç–∞–≤–∏–≤ –∫—É—Ä—Å–æ—Ä —Å—é–¥–∞:*\n\n–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞–∂–º–∏—Ç–µ [Ctrl+0].\n\n–ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–µ—Ç–æ–≤:\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–∏—Ñ—Ä–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º - Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X\n\n–¢–∞–∫–∂–µ —É–¥–æ–±–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–æ—á–µ—Ç–∞–Ω–∏—è–º–∏ –∫–ª–∞–≤–∏—à –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è - Ctrl+—Å—Ç—Ä–µ–ª–∫–∞, Shift+—Å—Ç—Ä–µ–ª–∫–∞, Ctrl+Shift+—Å—Ç—Ä–µ–ª–∫–∞\n\n–ù–∞–∑—ã–≤–∞–π—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø–æ –ø–µ—Ä–≤—ã–º –±—É–∫–≤–∞–º —Å–ª–æ–≤.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º–≤–æ–ª—ã-—Å—É—Ñ—Ñ–∏–∫—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, \\, —ä, +) –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π. –í —Ä–∞–∑–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä—è—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—É—Ñ—Ñ–∏–∫—Å—ã, —ç—Ç–æ —É–º–µ–Ω—å—à–∏—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π.\n\n–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–ª–æ–≤–∞—Ä—å –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≤ –Ω–µ–≥–æ –ø—Ä–∞–≤–æ–∫, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –æ—á–∏—â–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.",
	};
  }

  loadActiveDictionaries() {
    const saved = localStorage.getItem('textEditorActiveDictionaries');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        const activeSet = new Set();
        for (let [key, value] of Object.entries(parsed)) {
          if (value) activeSet.add(key);
        }
        return activeSet;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π:', e);
      }
    }
    
    const active = new Set();
    if (this.dictionaries && this.dictionaries['default']) {
      active.add('default');
    }
    return active;
  }

  saveDictionaries() {
    localStorage.setItem('textEditorDictionaries', JSON.stringify(this.dictionaries));
  }

  saveActiveDictionaries() {
    const activeObj = {};
    for (let name in this.dictionaries) {
      activeObj[name] = this.activeDictionaries.has(name);
    }
    localStorage.setItem('textEditorActiveDictionaries', JSON.stringify(activeObj));
  }

  getActiveDictionary() {
    return this.combinedActiveDictionary;
  }

  loadDictionaryFromFile(file, fileName) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const newDict = JSON.parse(e.target.result);
        if (typeof newDict === 'object' && newDict !== null) {
          this.dictionaries[fileName] = newDict;
          if (Object.keys(this.dictionaries).length === 1) {
            this.activeDictionaries.add(fileName);
          }
          this.saveDictionaries();
          this.saveActiveDictionaries();
          this.rebuildActiveDictionary();
          this.checkConflicts();
          this.renderShortcutsTable();
          this.renderDictionariesList();
          this.updateConflictStatus();
          this.updateCurrentDictNameDisplay();
          this.clearEditFields();
        } else {
          alert('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç —Å–ª–æ–≤–∞—Ä—è.');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
      }
    };
    reader.readAsText(file);
  }

  removeDictionary(dictName) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å "${dictName}"?`)) {
      delete this.dictionaries[dictName];
      this.activeDictionaries.delete(dictName);
      if (this.selectedDictionaryName === dictName) {
        this.selectedDictionaryName = null;
      }
      this.saveDictionaries();
      this.saveActiveDictionaries();
      this.rebuildActiveDictionary();
      this.checkConflicts();
      this.renderShortcutsTable();
      this.renderDictionariesList();
      this.updateConflictStatus();
      this.updateCurrentDictNameDisplay();
      this.clearEditFields();
    }
  }

  toggleDictionary(dictName) {
    if (this.activeDictionaries.has(dictName)) {
      this.activeDictionaries.delete(dictName);
    } else {
      this.activeDictionaries.add(dictName);
    }
    this.saveActiveDictionaries();
    this.rebuildActiveDictionary();
    this.checkConflicts();
    this.renderShortcutsTable();
    this.renderDictionariesList();
    this.updateConflictStatus();
    this.clearEditFields();
  }

  exportDictionary(dictName) {
    if (this.dictionaries[dictName]) {
      const json = JSON.stringify(this.dictionaries[dictName], null, 2);
      const blob = new Blob([json], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = dictName + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }

  rebuildActiveDictionary() {
    this.combinedActiveDictionary = {};
    for (let name of this.activeDictionaries) {
      const dict = this.dictionaries[name];
      if (dict) {
        Object.assign(this.combinedActiveDictionary, dict);
      }
    }
    for (let conflict of this.conflictingShortcuts) {
      delete this.combinedActiveDictionary[conflict];
    }
  }

  checkConflicts() {
    this.conflictingShortcuts.clear();
    this.conflictDetails = {};
    const shortcutSources = {};
    
    for (let name of this.activeDictionaries) {
      const dict = this.dictionaries[name];
      if (dict) {
        for (let shortcut in dict) {
          if (!shortcutSources[shortcut]) {
            shortcutSources[shortcut] = [];
          }
          shortcutSources[shortcut].push(name);
        }
      }
    }
    
    for (let shortcut in shortcutSources) {
      if (shortcutSources[shortcut].length > 1) {
        this.conflictingShortcuts.add(shortcut);
        this.conflictDetails[shortcut] = shortcutSources[shortcut];
      }
    }
  }

  updateConflictStatus() {
    const statusElement = document.getElementById('conflict-status');
    if (this.conflictingShortcuts.size > 0) {
      const conflictMessages = [];
      for (let shortcut in this.conflictDetails) {
        const sources = this.conflictDetails[shortcut];
        if (sources.length > 1) {
          conflictMessages.push(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç: '${shortcut}' –≤ '${sources[0]}' –∏ '${sources[1]}'`);
          if (sources.length > 2) {
            conflictMessages[conflictMessages.length - 1] += ` –∏ –µ—â—ë ${sources.length - 2}`;
          }
        }
      }
      statusElement.textContent = conflictMessages.join('; ');
      statusElement.style.display = 'block';
    } else {
      statusElement.style.display = 'none';
    }
  }

  renderDictionariesList() {
    const tbody = document.getElementById('dictionaries-table-body');
    tbody.innerHTML = '';
    
    for (let name in this.dictionaries) {
      const row = document.createElement('tr');
      row.dataset.dictName = name;
      if (this.selectedDictionaryName === name) {
        row.classList.add('selected');
      }
      
      const toggleCell = document.createElement('td');
      const nameCell = document.createElement('td');
      const actionsCell = document.createElement('td');
      
      const toggleCheckbox = document.createElement('input');
      toggleCheckbox.type = 'checkbox';
      toggleCheckbox.checked = this.activeDictionaries.has(name);
      toggleCheckbox.dataset.dictName = name;
      toggleCheckbox.addEventListener('change', (e) => {
        this.toggleDictionary(e.target.dataset.dictName);
      });
      
      toggleCell.appendChild(toggleCheckbox);
      nameCell.textContent = name;
      actionsCell.innerHTML = `
        <button class="export-dict-btn" data-dict-name="${name}">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="delete-dict-btn" data-dict-name="${name}">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      
      row.appendChild(toggleCell);
      row.appendChild(nameCell);
      row.appendChild(actionsCell);
      tbody.appendChild(row);
    }
  }

  renderShortcutsTable() {
    const tbody = document.getElementById('shortcuts-table-body');
    tbody.innerHTML = '';
    
    let dictToRender = this.combinedActiveDictionary;
    if (this.selectedDictionaryName && this.dictionaries[this.selectedDictionaryName]) {
      dictToRender = this.dictionaries[this.selectedDictionaryName];
    }
    
    for (let shortcut in dictToRender) {
      const row = document.createElement('tr');
      row.dataset.shortcut = shortcut;
      if (this.selectedShortcut === shortcut) {
        row.classList.add('selected');
      }
      if (this.selectedDictionaryName &&
          this.activeDictionaries.has(this.selectedDictionaryName) &&
          this.conflictingShortcuts.has(shortcut)) {
        row.classList.add('conflicting-shortcut-row');
      }
      
      const shortcutCell = document.createElement('td');
      shortcutCell.textContent = shortcut;
      
      const replacementCell = document.createElement('td');
      const preview = dictToRender[shortcut].substring(0, 50);
      replacementCell.textContent = preview + (dictToRender[shortcut].length > 50 ? '...' : '');
      
      row.appendChild(shortcutCell);
      row.appendChild(replacementCell);
      tbody.appendChild(row);
    }
  }

  addOrUpdateShortcut(shortcut, replacement) {
    if (!shortcut || !shortcut.trim()) {
      DOMUtils.showError(document.getElementById('shortcut-error'), '–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      return false;
    }
    
    shortcut = shortcut.trim();
    replacement = replacement || '';
    
    let foundInDict = null;
    for (let name in this.dictionaries) {
      if (this.dictionaries[name][shortcut] !== undefined) {
        foundInDict = name;
        break;
      }
    }
    
    if (foundInDict) {
      const userConfirmed = confirm(`–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ "${shortcut}" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–º–µ–Ω–∏—Ç—å?`);
      if (!userConfirmed) {
        DOMUtils.clearError(document.getElementById('shortcut-error'));
        return false;
      }
      this.dictionaries[foundInDict][shortcut] = replacement;
    } else {
      const targetDictName = this.selectedDictionaryName || 
                             this.activeDictionaries.values().next().value || 
                             'default';
      if (!this.dictionaries[targetDictName]) {
        this.dictionaries[targetDictName] = {};
      }
      this.dictionaries[targetDictName][shortcut] = replacement;
    }
    
    this.saveDictionaries();
    this.rebuildActiveDictionary();
    this.checkConflicts();
    this.renderShortcutsTable();
    this.selectShortcut(shortcut);
    this.renderDictionariesList();
    this.updateConflictStatus();
    DOMUtils.clearError(document.getElementById('shortcut-error'));
    return true;
  }

  deleteShortcut(shortcut) {
    if (shortcut) {
      let foundInDict = null;
      for (let name in this.dictionaries) {
        if (this.dictionaries[name][shortcut] !== undefined) {
          foundInDict = name;
          break;
        }
      }
      
      if (foundInDict) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ "${shortcut}" –∏–∑ —Å–ª–æ–≤–∞—Ä—è "${foundInDict}"?`)) {
          delete this.dictionaries[foundInDict][shortcut];
          this.saveDictionaries();
          this.rebuildActiveDictionary();
          this.checkConflicts();
          this.renderShortcutsTable();
          this.selectedShortcut = null;
          this.clearEditFields();
          this.renderDictionariesList();
          this.updateConflictStatus();
          return true;
        }
      }
    }
    return false;
  }

  setupEventListeners() {
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const tabId = e.target.getAttribute('data-tab');
        this.switchTab(tabId);
      });
    });
    
    document.getElementById('shortcuts-table-body').addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (row && row.dataset.shortcut) {
        this.selectShortcut(row.dataset.shortcut);
      }
    });
    
    document.getElementById('dictionaries-table-body').addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (row && row.dataset.dictName) {
        this.selectedShortcut = null;
        document.querySelectorAll('#dictionaries-table-body tr').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        this.selectedDictionaryName = row.dataset.dictName;
        this.clearEditFields();
        this.renderShortcutsTable();
        this.updateCurrentDictNameDisplay();
      }
    });
    
    document.getElementById('save-shortcut-btn').addEventListener('click', () => {
      const shortcut = document.getElementById('edit-shortcut').value;
      const replacement = document.getElementById('edit-replacement').value;
      this.addOrUpdateShortcut(shortcut, replacement);
    });
    
    document.getElementById('delete-shortcut-btn').addEventListener('click', () => {
      const shortcut = document.getElementById('edit-shortcut').value;
      if (shortcut) {
        this.deleteShortcut(shortcut);
      }
    });
    
    document.getElementById('dictionaries-table-body').addEventListener('click', (e) => {
      if (e.target.classList.contains('export-dict-btn')) {
        const dictName = e.target.dataset.dictName;
        this.exportDictionary(dictName);
      }
      if (e.target.classList.contains('delete-dict-btn')) {
        const dictName = e.target.dataset.dictName;
        this.removeDictionary(dictName);
      }
    });
  }

  setupDropZone() {
    const dropZone = document.getElementById('drop-zone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('dragover');
      }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('dragover');
      }, false);
    });
    
    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length) {
        const file = files[0];
        let fileName = file.name;
        if (fileName.endsWith('.txt')) {
          fileName = fileName.substring(0, fileName.length - 4);
        }
        if (this.dictionaries[fileName]) {
          if (!confirm(`–°–ª–æ–≤–∞—Ä—å "${fileName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–º–µ–Ω–∏—Ç—å?`)) {
            return;
          }
        }
        this.loadDictionaryFromFile(file, fileName);
      }
    });
  }

  switchTab(tabId) {
    document.querySelectorAll('[id$="-tab"]').forEach(tab => {
      tab.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
    
    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  }

  selectShortcut(shortcut) {
    this.selectedShortcut = shortcut;
    document.querySelectorAll('#shortcuts-table-body tr').forEach(row => row.classList.remove('selected'));
    const row = document.querySelector(`#shortcuts-table-body tr[data-shortcut="${shortcut}"]`);
    if (row) row.classList.add('selected');
    
    document.getElementById('edit-shortcut').value = shortcut;
    let dictToUse = this.combinedActiveDictionary;
    if (this.selectedDictionaryName && this.dictionaries[this.selectedDictionaryName]) {
      dictToUse = this.dictionaries[this.selectedDictionaryName];
    }
    document.getElementById('edit-replacement').value = dictToUse[shortcut] || '';
    this.updateButtonsState();
    DOMUtils.clearError(document.getElementById('shortcut-error'));
  }

  clearEditFields() {
    document.getElementById('edit-shortcut').value = '';
    document.getElementById('edit-replacement').value = '';
    this.updateButtonsState();
    DOMUtils.clearError(document.getElementById('shortcut-error'));
  }

  updateButtonsState() {
    const deleteBtn = document.getElementById('delete-shortcut-btn');
    const shortcut = document.getElementById('edit-shortcut').value;
    let exists = false;
    
    for (let name in this.dictionaries) {
      if (this.dictionaries[name][shortcut] !== undefined) {
        exists = true;
        break;
      }
    }
    
    deleteBtn.disabled = !exists;
  }

  updateCurrentDictNameDisplay() {
    const titleElement = document.getElementById('editing-dict-title');
    if (this.selectedDictionaryName) {
      titleElement.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è "${this.selectedDictionaryName}"`;
    } else {
      titleElement.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è';
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const titleElement = document.getElementById('animated-title');
  const sequence = ['|','n|', 'nw|', 'NW', 'NoWa', 'NotWar', 'NoteWarp'];
  let isAnimating = false;
  
  titleElement.addEventListener('click', () => {
    if (isAnimating) return;
    isAnimating = true;
    let index = 0;
    const interval = setInterval(() => {
      if (index < sequence.length) {
        titleElement.textContent = sequence[index];
        if (index === 3) {
          clearInterval(interval);
          const newInterval = setInterval(() => {
            index++;
            if (index < sequence.length) {
              titleElement.textContent = sequence[index];
            } else {
              clearInterval(newInterval);
              isAnimating = false;
            }
          }, 50);
        }
        index++;
      } else {
        clearInterval(interval);
        isAnimating = false;
      }
    }, 200);
  });
  
  const dictionaryManager = new DictionaryManager();
  const feedbackManager = new FeedbackManager();
  const editorElement = document.getElementById('editor');
  const editor = new TextEditor(editorElement, dictionaryManager, feedbackManager);
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  const settingsButton = document.getElementById('settings-button');
  const closeSettingsBtn = document.getElementById('close-settings-btn');
  const settingsPopup = document.getElementById('settings-popup');
  
  settingsButton.addEventListener('click', () => {
    settingsPopup.style.display = 'flex';
  });
  
  closeSettingsBtn.addEventListener('click', () => {
    settingsPopup.style.display = 'none';
  });
  
  // –°–ø—Ä–∞–≤–∫–∞
  const helpButton = document.getElementById('help-button');
  const helpPopup = document.getElementById('help-popup');
  const closeHelpBtn = document.getElementById('close-help-btn');
  
  helpButton.addEventListener('click', () => {
    helpPopup.style.display = 'flex';
  });
  
  closeHelpBtn.addEventListener('click', () => {
    helpPopup.style.display = 'none';
  });
  
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ —Å–ø—Ä–∞–≤–∫–∏
  document.querySelectorAll('.help-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      
      // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.help-tab-content').forEach(c => c.classList.remove('active'));
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
      tab.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    });
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–∞–ø–æ–≤ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
  [settingsPopup, helpPopup].forEach(popup => {
    popup.addEventListener('click', (e) => {
      if (e.target === popup) {
        popup.style.display = 'none';
      }
    });
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      settingsPopup.style.display = 'none';
      helpPopup.style.display = 'none';
    }
  });
  
  editorElement.focus();
});
</script>
</body>
</html>